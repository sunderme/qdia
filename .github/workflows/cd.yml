name: CD
on:
  - push
  - pull_request

jobs:
  build-win:
    name: win build (msys2)
    if: github.event_name == 'push'
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: git mingw-w64-x86_64-cmake make mingw-w64-x86_64-ninja mingw-w64-x86_64-toolchain mingw-w64-x86_64-qt6-base mingw-w64-x86_64-qt6-svg mingw-w64-x86_64-qt6-tools mingw-w64-x86_64-nsis zip unzip
          
      - name: Fetch tag annotations
        run: git fetch --tags --force
      - name: Configure
        run: |
          mkdir build
          cd build
          cmake ..
      - name: Release translation
        run: |
          cd build
          cmake --build . --target qdia_lrelease
      - name: Build
        run: |
          cd build
          cmake --build .
      
      - name: Package
        id: package
        run: |
          cd build
          VERSION_NAME=`git describe`
          ../.github/scripts/package_msys.sh
          echo "VERSION_NAME=${VERSION_NAME}">> $GITHUB_OUTPUT

      - name: Upload zip to GitHub Artifacts
        if: github.event_name == 'push'
        uses: actions/upload-artifact@v3
        with:
          name: qdia-win-qt6-zip
          path: ./build/package-zip/qdia-win-qt6-${{ steps.package.outputs.VERSION_NAME }}.zip
          
      - name: Upload to GitHub Artifacts
        if: github.event_name == 'push'
        uses: actions/upload-artifact@v3
        with:
          name: qdia-win-qt6-exe
          path: ./build/qdia-win-qt6-${{ steps.package.outputs.VERSION_NAME }}.exe
        
      - name: Release exe
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
          files: |
            ./build/qdia-win-qt6-${{ steps.package.outputs.VERSION_NAME }}.exe
            ./build/package-zip/qdia-win-qt6-${{ steps.package.outputs.VERSION_NAME }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUBTOKEN }}

###################################

  build-linux-release:
    name: linux appimage
    if: github.event_name == 'push'
    runs-on: ubuntu-20.04
    steps:
    - name: Checkout
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Fetch tag annotations
      run: git fetch --tags --force

    - name: Updates
      run: sudo apt-get update

    - name: Dependencies
      run: sudo apt-get install qtbase5-dev qt5-default cmake libqt5svg5-dev qttools5-dev

    - name: Configure
      run: |
        mkdir build
        cd build
        cmake -DCMAKE_INSTALL_PREFIX=appdir/usr ..

    - name: Build
      run: |
        cd build
        cmake --build . --target install
      
    - name: Package
      id: package
      run: |
        cd build
        VERSION_NAME=`git describe`
        . ../.github/scripts/package_linux.sh
        echo "VERSION_NAME=${VERSION_NAME}">> $GITHUB_OUTPUT
        
    - name: Upload to Github Artifacts
      if: github.event_name == 'push'
      uses: actions/upload-artifact@v3
      with:
        name: qdia-linux
        path: QDia-linux-${{ steps.package.outputs.VERSION_NAME }}-x86_64.AppImage
        
    - name: Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
        files: QDia-linux-${{ steps.package.outputs.VERSION_NAME }}-x86_64.AppImage
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUBTOKEN }}
   

   
############################
      
  macosx:
    name: Mac OS X
    runs-on: macos-latest
    if: true

    steps:
    - name: Checkout
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Fetch tag annotations
      run: git fetch --tags --force

    - name: Install Dependencies
      run: |
        brew install qt

    - name: fix rpath
      run: |
        python2 ./.github/scripts/fixRpath.py /usr/local/opt/qt/lib

    - name: Configure
      run: |
        mkdir build
        cd build
        cmake ..

    - name: Release translation
      run: cmake --build build --target qdia_lrelease

    - name: Build
      run: cmake --build build

    - name: Workarounds
      run: |
        mkdir -p texstudio.app/Contents/PlugIns/imageformats
        cp /usr/local/opt/qt/share/qt/plugins/imageformats/libqsvg.dylib texstudio.app/Contents/PlugIns/imageformats
        mkdir -p texstudio.app/Contents/Frameworks
        cp /usr/local/lib/libbrotlicommon.1.dylib texstudio.app/Contents/Frameworks

    - name: Package
      id: package
      run: |
        cd build
        /usr/local/opt/qt6/bin/macdeployqt qdia.app -dmg
        VERSION_NAME=`git describe`
        cp qdia.dmg qdia-osx-${VERSION_NAME}.dmg
        echo "VERSION_NAME=${VERSION_NAME}">> $GITHUB_OUTPUT
        
    - name: Upload to Github artifacts
      if: github.event_name == 'push'
      uses: actions/upload-artifact@v3
      with:
        name: qdia-osx
        path: build/qdia-osx-${{ steps.package.outputs.VERSION_NAME }}.dmg
        
    - name: Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
        files: build/qdia-osx-${{ steps.package.outputs.VERSION_NAME }}.dmg
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUBTOKEN }}
        
 
